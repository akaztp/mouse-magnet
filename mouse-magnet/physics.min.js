(function(){var n=this,t=n.Physics;common=function(){var t={},n=Array.prototype,i=Object.prototype,h=i.hasOwnProperty,c=n.slice,r=n.forEach,u=n.indexOf,f=i.toString,l=function(n,t){return h.call(n,t)},e=function(n,i,u){var f,o,e;if(n!=null)if(r&&n.forEach===r)n.forEach(i,u);else if(n.length===+n.length){for(f=0,o=n.length;f<o;f++)if(f in n&&i.call(u,n[f],f,n)===t)return}else for(e in n)if(_.has(n,e)&&i.call(u,n[e],e,n)===t)return},o=function(n){return n},s=function(n,t,i){var r,u,f;for(i||(i=o),r=0,u=n.length;r<u;)f=r+u>>1,i(n[f])<i(t)?r=f+1:u=f;return r};return{has:l,each:e,extend:function(n){return e(c.call(arguments,1),function(t){for(var i in t)n[i]=t[i]}),n},indexOf:function(n,t,i){if(n==null)return-1;var r,f;if(i)return r=s(n,t),n[r]===t?r:-1;if(u&&n.indexOf===u)return n.indexOf(t);for(r=0,f=n.length;r<f;r++)if(r in n&&n[r]===t)return r;return-1},sortedIndex:s,identity:o,isNumber:function(n){return f.call(n)=="[object Number]"},isFunction:function(n){return f.call(n)=="[object Function]"||typeof n=="function"},isUndefined:function(n){return n===void 0},isNull:function(n){return n===null}}}();Vector=function(n){var t=function(n,t){this.x=n||0;this.y=t||0};return n.extend(t.prototype,{set:function(n,t){return this.x=n,this.y=t,this},copy:function(n){return this.x=n.x,this.y=n.y,this},clear:function(){return this.x=0,this.y=0,this},clone:function(){return new t(this.x,this.y)},add:function(n,t){return this.x=n.x+t.x,this.y=n.y+t.y,this},addSelf:function(n){return this.x+=n.x,this.y+=n.y,this},sub:function(n,t){return this.x=n.x-t.x,this.y=n.y-t.y,this},subSelf:function(n){return this.x-=n.x,this.y-=n.y,this},multiplySelf:function(n){return this.x*=n.x,this.y*=n.y,this},multiplyScalar:function(n){return this.x*=n,this.y*=n,this},divideScalar:function(n){return n?(this.x/=n,this.y/=n):this.set(0,0),this},negate:function(){return this.multiplyScalar(-1)},dot:function(n){return this.x*n.x+this.y*n.y},lengthSquared:function(){return this.x*this.x+this.y*this.y},length:function(){return Math.sqrt(this.lengthSquared())},normalize:function(){return this.divideScalar(this.length())},distanceTo:function(n){return Math.sqrt(this.distanceToSquared(n))},distanceToSquared:function(n){var t=this.x-n.x,i=this.y-n.y;return t*t+i*i},setLength:function(n){return this.normalize().multiplyScalar(n)},equals:function(n){return this.distanceTo(n)<.0001},lerp:function(n,t){var i=(n.x-this.x)*t+this.x,r=(n.y-this.y)*t+this.y;return this.set(i,r)},isZero:function(){return this.length()<.0001}}),t}(common);n.Physics=Physics=function(n,t,i){function f(){var n,i;for(t(f),n=0;n<r.length;n++)i=r[n],i.playing&&i.update()}var r=[],u=function(){var t=this;this.playing=!1;n.apply(this,arguments);this.animations=[];this.equilibriumCallbacks=[];r.push(this)};return i.extend(u,n,{superclass:n}),i.extend(u.prototype,n.prototype,{play:function(){return this.playing?this:(this.playing=!0,this.__equilibrium=!1,this)},pause:function(){return this.playing=!1,this},toggle:function(){return this.playing?this.pause():this.play(),this},onUpdate:function(n){return i.indexOf(this.animations,n)>=0||!i.isFunction(n)?this:(this.animations.push(n),this)},onEquilibrium:function(n){return i.indexOf(this.equilibriumCallbacks,n)>=0||!i.isFunction(n)?this:(this.equilibriumCallbacks.push(n),this)},update:function(){if(this.__optimized&&this.__equilibrium)return this;var n;for(this.tick(),n=0;n<this.animations.length;n++)this.animations[n]();if(this.__optimized&&this.__equilibrium)for(n=0;n<this.equilibriumCallbacks.length;n++)this.equilibriumCallbacks[n]();return this}}),f(),u}(ParticleSystem=function(n,t,i,r,u,f){var e=function(){this.__equilibriumCriteria={particles:!0,springs:!0,attractions:!0};this.__equilibrium=!1;this.__optimized=!1;this.particles=[];this.springs=[];this.attractions=[];this.forces=[];this.integrator=new u(this);this.hasDeadParticles=!1;var t=arguments.length;t===1?(this.gravity=new n(0,arguments[0]),this.drag=e.DEFAULT_DRAG):t===2?(this.gravity=new n(0,arguments[0]),this.drag=arguments[1]):t===3?(this.gravity=new n(arguments[0],arguments[1]),this.drag=arguments[3]):(this.gravity=new n(0,e.DEFAULT_GRAVITY),this.drag=e.DEFAULT_DRAG)};return f.extend(e,{DEFAULT_GRAVITY:0,DEFAULT_DRAG:.001,Attraction:r,Integrator:u,Particle:t,Spring:i,Vector:n}),f.extend(e.prototype,{optimize:function(n){return this.__optimized=!!n,this},setGravity:function(n,t){return this.gravity.set(n,t),this},setEquilibriumCriteria:function(n,t,i){this.__equilibriumCriteria.particles=!!n;this.__equilibriumCriteria.springs=!!t;this.__equilibriumCriteria.attractions=!!i},tick:function(){return this.integrator.step(arguments.length===0?1:arguments[0]),this.__optimized&&(this.__equilibrium=!this.needsUpdate()),this},needsUpdate:function(){var n=0;if(this.__equilibriumCriteria.particles)for(n=0,l=this.particles.length;n<l;n++)if(!this.particles[n].resting())return!0;if(this.__equilibriumCriteria.springs)for(n=0,l=this.springs.length;n<l;n++)if(!this.springs[n].resting())return!0;if(this.__equilibriumCriteria.attractions)for(n=0,l=this.attractions.length;n<l;n++)if(!this.attractions[n].resting())return!0;return!1},addParticle:function(n){return this.particles.push(n),this},addSpring:function(n){return this.springs.push(n),this},addAttraction:function(n){return this.attractions.push(n),this},makeParticle:function(n,i,r){var e=f.isNumber(n)?n:1,i=i||0,r=r||0,u=new t(e);return u.position.set(i,r),this.addParticle(u),u},makeSpring:function(n,t,r,u,f){var e=new i(n,t,r,u,f);return this.addSpring(e),e},makeAttraction:function(n,t,i,u){var f=new r(n,t,i,u);return this.addAttraction(f),f},clear:function(){this.particles.length=0;this.springs.length=0;this.attractions.length=0},applyForces:function(){var t,i,r;if(!this.gravity.isZero())for(t=0;t<this.particles.length;t++)this.particles[t].force.addSelf(this.gravity);for(r=new n,t=0;t<this.particles.length;t++)i=this.particles[t],r.set(i.velocity.x*-1*this.drag,i.velocity.y*-1*this.drag),i.force.addSelf(r);for(t=0;t<this.springs.length;t++)this.springs[t].update();for(t=0;t<this.attractions.length;t++)this.attractions[t].update();for(t=0;t<this.forces.length;t++)this.forces[t].update();return this},clearForces:function(){for(var n=0;n<this.particles.length;n++)this.particles[n].clear();return this}}),e}(Vector,Particle=function(n,t){var i=function(t){this.position=new n;this.velocity=new n;this.force=new n;this.mass=t;this.fixed=!1;this.age=0;this.dead=!1};return t.extend(i.prototype,{distanceTo:function(n){return this.position.distanceTo(n.position)},makeFixed:function(){return this.fixed=!0,this.velocity.clear(),this},reset:function(){return this.age=0,this.dead=!1,this.position.clear(),this.velocity.clear(),this.force.clear(),this.mass=1,this},resting:function(){return this.fixed||this.velocity.isZero()&&this.force.isZero()}}),i}(Vector,common),Spring=function(n,t){var i=function(n,t,i,r,u){this.constant=i;this.damping=r;this.length=u;this.a=n;this.b=t;this.on=!0};return t.extend(i.prototype,{currentLength:function(){return this.a.position.distanceTo(this.b.position)},update:function(){var i=this.a,r=this.b,t,u;if(!(this.on&&(!i.fixed||!r.fixed)))return this;t=(new n).sub(i.position,r.position);u=t.length();u===0?t.clear():t.divideScalar(u);var f=-1*(u-this.length)*this.constant,e=(new n).sub(i.velocity,r.velocity),o=-1*this.damping*e.dot(t),s=f+o;return t.multiplyScalar(s),i.fixed||i.force.addSelf(t),r.fixed||r.force.subSelf(t),this},resting:function(){var n=this.a,t=this.b,i=this.length;return!this.on||n.fixed&&t.fixed||n.fixed&&(i===0?t.position.equals(n.position):t.position.distanceTo(n.position)<=i)&&t.resting()||t.fixed&&(i===0?n.position.equals(t.position):n.position.distanceTo(t.position)<=i)&&n.resting()}}),i}(Vector,common),Attraction=function(n,t){var i=function(n,t,i,r){this.a=n;this.b=t;this.constant=i;this.on=!0;this.distanceMin=r;this.distanceMinSquared=r*r};return t.extend(i.prototype,{update:function(){var t=this.a,i=this.b;if(this.on&&(!t.fixed||!i.fixed)){var o=t.position.x-i.position.x,s=t.position.y-i.position.y,r=(new n).sub(t.position,i.position),u=Math.max(r.lengthSquared(),this.distanceMinSquared),f=this.constant*t.mass*i.mass/u,e=Math.sqrt(u);return f===0||e===0?r.clear():r.divideScalar(e).multiplyScalar(f),t.fixed||t.force.subSelf(r),i.fixed||i.force.addSelf(r),this}},resting:function(){var n=this.a,t=this.b,i=this.distanceMin;return!this.on||n.fixed&&t.fixed||n.fixed&&t.position.distanceTo(n.position)<=i&&t.resting()||t.fixed&&n.position.distanceTo(t.position)<=i&&n.resting()}}),i}(Vector,common),Integrator=function(n,t){var i=function(n){this.s=n;this.originalPositions=[];this.originalVelocities=[];this.k1Forces=[];this.k1Velocities=[];this.k2Forces=[];this.k2Velocities=[];this.k3Forces=[];this.k3Velocities=[];this.k4Forces=[];this.k4Velocities=[]};return t.extend(i.prototype,{allocateParticles:function(){while(this.s.particles.length>this.originalPositions.length)this.originalPositions.push(new n),this.originalVelocities.push(new n),this.k1Forces.push(new n),this.k1Velocities.push(new n),this.k2Forces.push(new n),this.k2Velocities.push(new n),this.k3Forces.push(new n),this.k3Velocities.push(new n),this.k4Forces.push(new n),this.k4Velocities.push(new n);return this},step:function(n){var r=this.s,i,e,o,t,u,s,h,c,y,f,l,a,v,p;for(this.allocateParticles(),t=0;t<r.particles.length;t++)i=r.particles[t],i.fixed||(this.originalPositions[t].copy(i.position),this.originalVelocities[t].copy(i.velocity)),i.force.clear();for(r.applyForces(),t=0;t<r.particles.length;t++)i=r.particles[t],i.fixed||(this.k1Forces[t].copy(i.force),this.k1Velocities[t].copy(i.velocity)),i.force.clear();for(t=0;t<r.particles.length;t++)i=r.particles[t],i.fixed||(u=this.originalPositions[t],s=this.k1Velocities[t],e=u.x+s.x*.5*n,o=u.y+s.y*.5*n,i.position.set(e,o),f=this.originalVelocities[t],l=this.k1Forces[t],e=f.x+l.x*.5*n/i.mass,o=f.y+l.y*.5*n/i.mass,i.velocity.set(e,o));for(r.applyForces(),t=0;t<r.particles.length;t++)i=r.particles[t],i.fixed||(this.k2Forces[t].copy(i.force),this.k2Velocities[t].copy(i.velocity)),i.force.clear();for(t=0;t<r.particles.length;t++)i=r.particles[t],i.fixed||(u=this.originalPositions[t],h=this.k2Velocities[t],i.position.set(u.x+h.x*.5*n,u.y+h.y*.5*n),f=this.originalVelocities[t],a=this.k2Forces[t],i.velocity.set(f.x+a.x*.5*n/i.mass,f.y+a.y*.5*n/i.mass));for(r.applyForces(),t=0;t<r.particles.length;t++)i=r.particles[t],i.fixed||(this.k3Forces[t].copy(i.force),this.k3Velocities[t].copy(i.velocity)),i.force.clear();for(t=0;t<r.particles.length;t++)i=r.particles[t],i.fixed||(u=this.originalPositions[t],c=this.k3Velocities[t],i.position.set(u.x+c.x*n,u.y+c.y*n),f=this.originalVelocities[t],v=this.k3Forces[t],i.velocity.set(f.x+v.x*n/i.mass,f.y+v.y*n/i.mass));for(r.applyForces(),t=0;t<r.particles.length;t++)i=r.particles[t],i.fixed||(this.k4Forces[t].copy(i.force),this.k4Velocities[t].copy(i.velocity));for(t=0;t<r.particles.length;t++)i=r.particles[t],i.age+=n,i.fixed||(u=this.originalPositions[t],s=this.k1Velocities[t],h=this.k2Velocities[t],c=this.k3Velocities[t],y=this.k4Velocities[t],e=u.x+n/6*(s.x+2*h.x+2*c.x+y.x),o=u.y+n/6*(s.y+2*h.y+2*c.y+y.y),i.position.set(e,o),f=this.originalVelocities[t],l=this.k1Forces[t],a=this.k2Forces[t],v=this.k3Forces[t],p=this.k4Forces[t],e=f.x+n/(6*i.mass)*(l.x+2*a.x+2*v.x+p.x),o=f.y+n/(6*i.mass)*(l.y+2*a.y+2*v.y+p.y),i.velocity.set(e,o));return this}}),i}(Vector,common),common),requestAnimationFrame=function(){var n=n||this;return n.requestAnimationFrame||n.webkitRequestAnimationFrame||n.mozRequestAnimationFrame||n.oRequestAnimationFrame||n.msRequestAnimationFrame||function(t){n.setTimeout(t,1e3/60)}}(),common)})();